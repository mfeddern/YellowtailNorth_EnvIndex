<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>LinearModelsEnvPred</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>


<script src="LinearModelsDredge_files/libs/clipboard/clipboard.min.js"></script>
<script src="LinearModelsDredge_files/libs/quarto-html/quarto.js"></script>
<script src="LinearModelsDredge_files/libs/quarto-html/popper.min.js"></script>
<script src="LinearModelsDredge_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="LinearModelsDredge_files/libs/quarto-html/anchor.min.js"></script>
<link href="LinearModelsDredge_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="LinearModelsDredge_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="LinearModelsDredge_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="LinearModelsDredge_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="LinearModelsDredge_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#code-set-up" id="toc-code-set-up" class="nav-link" data-scroll-target="#code-set-up">Code set up</a></li>
  <li><a href="#evaluating-multicolinearity-and-temporal-stability-of-environmental-predictors" id="toc-evaluating-multicolinearity-and-temporal-stability-of-environmental-predictors" class="nav-link" data-scroll-target="#evaluating-multicolinearity-and-temporal-stability-of-environmental-predictors">1. Evaluating multicolinearity and temporal stability of environmental predictors</a>
  <ul class="collapse">
  <li><a href="#running-a-dfa" id="toc-running-a-dfa" class="nav-link" data-scroll-target="#running-a-dfa">Running a DFA</a></li>
  <li><a href="#assessing-the-weight-of-support-for-each-predictor-as-a-function-of-time-series-length" id="toc-assessing-the-weight-of-support-for-each-predictor-as-a-function-of-time-series-length" class="nav-link" data-scroll-target="#assessing-the-weight-of-support-for-each-predictor-as-a-function-of-time-series-length">Assessing the weight of support for each predictor as a function of time series length</a></li>
  <li><a href="#assessing-model-selection-based-on-aic-and-principles-of-parsimony" id="toc-assessing-model-selection-based-on-aic-and-principles-of-parsimony" class="nav-link" data-scroll-target="#assessing-model-selection-based-on-aic-and-principles-of-parsimony">Assessing model selection based on AIC and principles of parsimony</a></li>
  <li><a href="#considering-correlation-across-covariates-with-the-strongest-weights-of-evidence" id="toc-considering-correlation-across-covariates-with-the-strongest-weights-of-evidence" class="nav-link" data-scroll-target="#considering-correlation-across-covariates-with-the-strongest-weights-of-evidence">Considering correlation across covariates with the strongest weights of evidence</a></li>
  </ul></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">LinearModelsEnvPred</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>The northern Yellowtail STAT has identified 3 primary ways that the incorporation and evaluation of environmental indices could be improved upon for the 2025 assessment cycle, these include:</p>
<ol type="1">
<li><p>Expand on non-linear relationships considered between recruitment deviations and environmental responses, specifically, evaluate the benefit of using GAMs in addition to quadratic terms.</p></li>
<li><p>Compare predictive capacity of models (using Leave-Future-Out cross validation) in addition to model fit.</p></li>
<li><p>Consider time-varying relationships (non-stationarity) between environmental conditions and recruitment deviations.</p></li>
<li><p>Fitting models to recrutitment deviations from the base model and refitting with an environmental predictor has inherent circularity. Identifying additional indices that can be environmentally informed would benefit the process of developing environmentally informed assessments. These could include indices of juvenile abundance, growth, or maturity.</p></li>
<li><p>Methods for index selection currently include fitting all possible model combintations. Issues of multicollinearity and model fitting are challenging across assessment types (i.e.&nbsp;both groundfish and salmon struggle with this). Evaluating additional approaches to deal with both multicollinearity and variable selection that also can deal with extremely limited time series would be beneficial. These can include regularization and machine learning methods.</p></li>
</ol>
<p>These efforts are in addition to the work lead by Nick Tolmieri and Amanda Darby which</p>
<ol type="1">
<li><p>Generated a ecological profile for Yellowtail north based on life history information</p></li>
<li><p>Compared linear models including quadratic terms where aappropriate and omitting highly correlated predictors from the same model</p></li>
<li><p>Found the model with the best fit to the data using AIC and principles of parsimony</p></li>
<li><p>Evaluated model performance using jack knifing and predicting the last 4 years of data.</p></li>
</ol>
</section>
<section id="code-set-up" class="level2">
<h2 class="anchored" data-anchor-id="code-set-up">Code set up</h2>
<p>First we set up the appropriate packages and references. File paths will be in reference to where the .qmd is saved</p>
<div class="cell">

</div>
<p>Next we set up the appropriate directories and read in the data.</p>
<div class="cell">

</div>
<p>We can build the functions including quadratic terms and omitting data that are missing years. We pull out DDegg just so we do not exceed the limit of 31 terms - pulling this out was somewhat arbitrary based on Amandas perliminary results.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Y_rec ~ DDpre + DDlarv + DDpjuv + DDben + Tcop + Tpart + MLDpart + 
    MLDlarv + MLDpjuv + CSTlarv + CSTpjuv + LSTlarv + LSTpjuv + 
    HCIlarv + HCIpjuv + ONIpre + ONIlarv + ONIpjuv + PDOlarv + 
    PDOpjuv + LUSI + CutiSTIpjuv + CutiTUMIpjuv + BeutiTUMIpjuv + 
    BeutiSTIpjuv + header + I(LSTlarv^2) + I(ONIpre^2) + I(ONIlarv^2) + 
    I(CutiSTIpjuv^2)
&lt;environment: 0x7fca0a0520e0&gt;</code></pre>
</div>
</div>
</section>
<section id="evaluating-multicolinearity-and-temporal-stability-of-environmental-predictors" class="level2">
<h2 class="anchored" data-anchor-id="evaluating-multicolinearity-and-temporal-stability-of-environmental-predictors">1. Evaluating multicolinearity and temporal stability of environmental predictors</h2>
<section id="running-a-dfa" class="level3">
<h3 class="anchored" data-anchor-id="running-a-dfa">Running a DFA</h3>
<p>Before we fit models, lets first understand patterns of correlation and covariability across these environmnetal conditions. To start, lets look at a DFA. We find that across time series, there is a strong underlying trend that is predominantly loaded on by temperature time series and represents transport, mixed layer depth, and upwelling are not as well represented. The model struggles to converge with more than one latent trend.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="assessing-the-weight-of-support-for-each-predictor-as-a-function-of-time-series-length" class="level3">
<h3 class="anchored" data-anchor-id="assessing-the-weight-of-support-for-each-predictor-as-a-function-of-time-series-length">Assessing the weight of support for each predictor as a function of time series length</h3>
<p>Next we can look at the weight of evidence in support for each time series and consider how this might change based on the observed time period of recruitment deviations. For this approach we will dredge up to 5 covariates, we will consider quadratic terms, and omit combinations of highly correlated covariates. This is not to expressly identify “THE” model but as an exercise to identify the most important variables, and potential non-stationarities in that relationship. To fit these models we will use at least 10 years of data (1994 - 2004) and iteratively add in one year of data and refit the model set. Colors denote the over all aic weight across all models with that variable.</p>
<p>Two variables stand out, CUTI spring transition as a non-linear (quadratic) relationship and ONI during the preconditioning time period. Notably, the weight of evidence for a single time series really diminshes when when the model is fit to 1994 - 2011:2014 such that AIC is fairly distributed across time series.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If we try to fit a model that is highly parsimonious, by fitting only 1 covariate at a time in the same framework (or selecting the most parsimonious model) we get a different answer and find that Mixed layer depth during the larval lifestage is the most important. I find this result interesting because MLDlarv does not load onto our DFA significantly. Given all of this variability, its worth exploring these different models a bit more.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="assessing-model-selection-based-on-aic-and-principles-of-parsimony" class="level3">
<h3 class="anchored" data-anchor-id="assessing-model-selection-based-on-aic-and-principles-of-parsimony">Assessing model selection based on AIC and principles of parsimony</h3>
<p>Lets take a look at what the best models from Amanda and Nicks workflow looks like. If we assign the best model as the model with the lowest AIC we also identify the MLDlarv model. However, this model has an extremely low R^2 and also does not fit the most recent half of the time series.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now what if we relax teh requirement of having the most parsimonious model and instead focus on the best fit across the entire time series, we find the best model is CUTI STI with a quadratic term.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also look at a table of the best models. It becomes very apparent the top models include CUTI STI as a non-linear term, and the models that include it have much better R^2 values.</p>
<div class="cell">
<div class="cell-output-display">

<table>
 <thead>
  <tr>
   <th style="text-align:right;"> CutiSTIpjuv </th>
   <th style="text-align:right;"> I.CutiSTIpjuv.2. </th>
   <th style="text-align:right;"> DDpre </th>
   <th style="text-align:right;"> HCIlarv </th>
   <th style="text-align:right;"> MLDlarv </th>
   <th style="text-align:right;"> Tcop </th>
   <th style="text-align:right;"> R2 </th>
   <th style="text-align:right;"> AICc </th>
   <th style="text-align:right;"> delta </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> -0.22 </td>
   <td style="text-align:right;"> -0.30 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.37 </td>
   <td style="text-align:right;"> 27.12 </td>
   <td style="text-align:right;"> 0.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.23 </td>
   <td style="text-align:right;"> -0.28 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.21 </td>
   <td style="text-align:right;"> 0.44 </td>
   <td style="text-align:right;"> 28.16 </td>
   <td style="text-align:right;"> 1.04 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.16 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.21 </td>
   <td style="text-align:right;"> 28.79 </td>
   <td style="text-align:right;"> 1.67 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.23 </td>
   <td style="text-align:right;"> -0.27 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.42 </td>
   <td style="text-align:right;"> 28.90 </td>
   <td style="text-align:right;"> 1.78 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.20 </td>
   <td style="text-align:right;"> -0.24 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.09 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.41 </td>
   <td style="text-align:right;"> 28.99 </td>
   <td style="text-align:right;"> 1.87 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> -0.26 </td>
   <td style="text-align:right;"> -0.28 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> -0.32 </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> NA </td>
   <td style="text-align:right;"> 0.41 </td>
   <td style="text-align:right;"> 29.09 </td>
   <td style="text-align:right;"> 1.97 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
<section id="considering-correlation-across-covariates-with-the-strongest-weights-of-evidence" class="level3">
<h3 class="anchored" data-anchor-id="considering-correlation-across-covariates-with-the-strongest-weights-of-evidence">Considering correlation across covariates with the strongest weights of evidence</h3>
<p>Using the first framework we look at, we can take the entire time series through 2014, and look at what predictors have the most evidence of support. Lets say that we only want to look at predictors that have at least 15% of the model support for the full time series. Looking at the data this way, the covariates that have the best weight of evidence are: long shore transport (larv), ONI (pelagic juveniles, larval, and preconditioning), CUTI STI, degree days benthic juveniles, and mixed layer depth larval.</p>
<div class="cell">
<div class="cell-output-display">

<table>
 <thead>
  <tr>
   <th style="text-align:right;"> last_year </th>
   <th style="text-align:left;"> variable </th>
   <th style="text-align:right;"> value </th>
   <th style="text-align:left;"> indicator </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:left;"> MLDlarv </td>
   <td style="text-align:right;"> 0.2060605 </td>
   <td style="text-align:left;"> MLDla </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Thinking about the variables with the most weight of evidence, we can test out a backwards selection technique. Instead of AIC (which is prone to overfitting and we already know these variables have AIC support) we can use VIF to try and avoid multicollinerity. Lets start with the model that is saturated with the variables that have strong AIC support.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    LSTlarv     ONIpjuv     ONIlarv      ONIpre CutiSTIpjuv     MLDpjuv 
       1.88        2.91       32.64       28.47        1.36        1.63 
      DDben 
       1.88 </code></pre>
</div>
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>ONIlarv is correlated with a bunch of covariates. Lets ditch it.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    LSTlarv     ONIpjuv      ONIpre CutiSTIpjuv     MLDpjuv       DDben 
       1.62        2.26        1.25        1.35        1.47        1.88 </code></pre>
</div>
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And finally, what does this model look like? We get a slightly worse fit than just using upwelling, and we still struggle with overestimating recruitment when it is low (the negative values)</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We don’t want to use DFA latent trends as predictors because they lack transparity and interpretibility - but lets look at it…it is GARBAGE. Why? Likely because it is dominated by temperature and not influenced by the transport, upwelling and mixed layer depth variables that provide better fits. Therefore, even using a DFA would require some degree of covariate exploration for any explanatory power or predictive ability.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="LinearModelsDredge_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<ol type="1">
<li><p>Fit GAMs with temporally stable relationships (status: code development)</p></li>
<li><p>Evaluate non-stationary relationships between recruitment deviations and the environmental predictors with the most support to assess non-stationarity</p></li>
<li><p>Perform model selection using LFO-CV (status: code development)</p></li>
<li><p>Fit models using regularization techniques</p></li>
<li><p>Fit models using machine learning techniques</p></li>
</ol>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>